name: FNF Indie Cross - Android Build

on:
  workflow_dispatch:

jobs:
  build-android:
    # نستخدم بيئة قوية مجهزة مسبقاً لأندرويد
    runs-on: ubuntu-latest
    
    # تحديد المتغيرات البيئية لـ Android NDK
    env:
      ANDROID_NDK_VERSION: r21e
      ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
      # هذا المسار يستخدمه Lime للبناء
      NDK_ROOT: /usr/local/lib/android/sdk/ndk-bundle

    steps:
    - name: 1. جلب الكود (Check out)
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: 2. تهيئة Haxe 4.1.5 و Neko
      uses: krdlab/setup-haxe@v1
      with:
        haxe-version: 4.1.5 # الإصدار المحدد
        neko-version: 2.3.0
        
    - name: 3. تثبيت مكتبات Haxelib
      run: |
        # تثبيت Lime بالإصدار المحدد
        haxelib install lime 7.9.0 
        haxelib install openfl
        haxelib install flixel
        haxelib run lime setup flixel
        haxelib run lime setup # تهيئة Lime 
        haxelib install flixel-tools
        haxelib install flixel-addons
        haxelib install flixel-ui
        haxelib install hscript
        haxelib install newgrounds
        haxelib install linc_luajit
        haxelib install actuate

        # تثبيت المكتبات الخاصة من GitHub
        haxelib git faxe https://github.com/uhrobots/faxe
        haxelib git polymod https://github.com/larsiusprime/polymod.git
        haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc
        haxelib git extension-webm https://github.com/KadeDev/extension-webm
        
        # تثبيت المكتبات الأخرى في ملف المشروع
        haxelib run lime update

    # ----------------------------------------------------
    # التعديل الجديد: تثبيت Android SDK/NDK بالطريقة الموثوقة
    - name: 4. تثبيت Android NDK/SDK (التهيئة الجديدة)
      uses: r3dsm/android-ndk-build@v3
      with:
          ndk-version: r21e # إصدار NDK معروف بالعمل مع HaxeFlixel

    # ----------------------------------------------------
    # الخطوة 5: إعادة بناء الامتدادات وبدء البناء
    - name: 5. إعادة بناء الامتدادات والبناء النهائي
      run: |
        haxelib run lime rebuild extension-webm android
        lime build android -release

    # الخطوة 6: رفع ملف APK الجاهز
    - name: 6. Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FNF_IndieCross_Android_APK
        path: export/android/bin/release/app-release.apk 
        retention-days: 7
