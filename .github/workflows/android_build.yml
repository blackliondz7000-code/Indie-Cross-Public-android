name: FNF Indie Cross - Android Build

on:
  workflow_dispatch:

jobs:
  build-android:
    runs-on: ubuntu-latest

    steps:
    - name: 1. جلب الكود (Check out)
      uses: actions/checkout@v4
      with:
        submodules: true

    - name: 2. تهيئة Haxe 4.1.5 
      uses: krdlab/setup-haxe@v1
      with:
        haxe-version: 4.1.5 
        
    # ----------------------------------------------------
    # خطوة 3: تثبيت المكتبات
    - name: 3.1 تثبيت Lime 7.9.0
      run: haxelib install lime 7.9.0 

    - name: 3.2.1 تثبيت OpenFL
      run: haxelib install openfl

    - name: 3.2.2 تثبيت Flixel
      run: haxelib install flixel

    - name: 3.2.3 إعداد Flixel
      run: haxelib run lime setup flixel

    - name: 3.2.4 إعداد Lime النهائي
      run: haxelib run lime setup
    
    - name: 3.3 تثبيت مكتبات FNF الإضافية
      run: |
        haxelib install flixel-tools
        haxelib install flixel-addons
        haxelib install flixel-ui
        haxelib install hscript
        haxelib install newgrounds
        haxelib install linc_luajit
        haxelib install actuate 

    - name: 3.4 تثبيت مكتبات Git الخاصة 
      run: |
        haxelib git faxe https://github.com/uhrobots/faxe 
        haxelib git polymod https://github.com/larsiusprime/polymod.git
        haxelib git discord_rpc https://github.com/Aidan63/linc_discord-rpc

    - name: 3.5 تثبيت extension-webm 
      run: haxelib git extension-webm https://github.com/KadeDev/extension-webm

    # ----------------------------------------------------
    # تثبيت Android SDK/NDK
    - name: 4. تثبيت Java JDK (JDK 17)
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'
        
    - name: 5. تثبيت Android SDK و NDK 
      run: |
        # تهيئة الأدوات (بدون تكرار للتوضيح)
        ANDROID_SDK_ROOT=$HOME/android_sdk
        echo "ANDROID_SDK_ROOT=$ANDROID_SDK_ROOT" >> $GITHUB_ENV
        mkdir -p $ANDROID_SDK_ROOT
        
        wget https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -O cmdline-tools.zip
        unzip cmdline-tools.zip -d $ANDROID_SDK_ROOT/cmdline-tools
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools/latest
        mv $ANDROID_SDK_ROOT/cmdline-tools/cmdline-tools/* $ANDROID_SDK_ROOT/cmdline-tools/latest/
        echo "$ANDROID_SDK_ROOT/cmdline-tools/latest/bin" >> $GITHUB_PATH

        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools" "platforms;android-34"

        wget https://dl.google.com/android/repository/android-ndk-r21e-linux-x86_64.zip
        unzip android-ndk-r21e-linux-x86_64.zip -d $HOME
        echo "NDK_ROOT=$HOME/android-ndk-r21e" >> $GITHUB_ENV
        
        echo "$ANDROID_SDK_ROOT/platform-tools" >> $GITHUB_PATH

    # ----------------------------------------------------
    # خطوة جديدة ومعدلة: تصحيح كود مصدر extension-webm
    - name: 5.5 تصحيح خطأ عدم تعريف read/close (الحل الموثوق)
      run: |
        # البحث في مجلدات المكتبات عن الملف المحدد
        FILE_PATH=$(find $HOME/.haxelib -name mkvmuxerutil.cpp | head -n 1)
        
        if [ -f "$FILE_PATH" ]; then
          echo "Patching $FILE_PATH to include unistd.h..."
          # إضافة include <unistd.h> في بداية الملف (السطر 2)
          sed -i '2i#include <unistd.h>' "$FILE_PATH"
          echo "Patching complete."
        else
          echo "mkvmuxerutil.cpp not found. Proceeding with caution."
        fi

    # ----------------------------------------------------
    # الخطوة 6: بناء ملف APK 
    - name: 6. بناء Android Release APK
      run: |
        # 1. فرض المعمارية كأول خطوة
        export HXCPP_ARM64=1
        
        # 2. إعداد المسارات
        haxelib run lime config ANDROID_SDK $ANDROID_SDK_ROOT
        haxelib run lime config ANDROID_NDK_ROOT $NDK_ROOT
        haxelib run lime config JAVA_HOME $JAVA_HOME
        haxelib run lime config ANDROID_SETUP true
        haxelib run lime setup android

        # 3. إعادة بناء الامتدادات (الآن مع HXCPP_ARM64 معرفة مسبقاً)
        haxelib run lime rebuild extension-webm android
        
        # 4. البناء النهائي
        haxelib run lime build android -release -D mobile
        
    # الخطوة 7: رفع ملف APK الجاهز
    - name: 7. Upload APK Artifact
      uses: actions/upload-artifact@v4
      with:
        name: FNF_IndieCross_Android_APK
        path: export/android/bin/release/app-release.apk 
        retention-days: 7
